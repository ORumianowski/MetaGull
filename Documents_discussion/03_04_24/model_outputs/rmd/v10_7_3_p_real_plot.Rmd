---
title: "Model v10_7_3_suvival - real dataset"
author: "Odin Rumianowski"
date: "2024-03-22"
output :
  html_document :
    toc : yes
    toc_float : yes
    warning : no
    message : no
    number_sections : yes
    code_fold : hide
    style : simplex
    theme: cosmo
    highlight: pygment
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```


```{r}
library(tidyverse)
library(ggplot2)
library(MCMCvis)
library(knitr)
library(patchwork)
```


# En résumé

survie sous estime et productivite sur estime

pistes:

1 - probleme de probabilite de détection

2 - probleme d initiation ds prebreeders

# Computational parameters

ni <- 30000; nb <- 10000; nc <- 3; nt <- 400; na <- 4000


```{r}
#load(file = "out1_integrated_v10_4.Rda")
load(file = "out1_integrated_v10_7_3_real.Rda")
```

# Main parameters
## Apparent survival probability

The values found by Péron are represented by the red dotted line

Péron : 

phi1 = 0.213 - First year

phiA = 0.860 - Subadult and adult

The analysis : 


```{r}
out1$mean$phi

```



```{r}
PR_unif_01 <- runif(1E9, 0, 1)
```


```{r}
gvals = c(0.213, 0.860)

MCMCtrace(out1, params = c("phi"),
          Rhat = T,
          priors = PR_unif_01,
          gvals = gvals,
          ind = T, pdf = F,
          post_zm = F)

```

## Productivity

D'après Péron:

rhoLR = 1.732 - La Ronze

rhoSAT = 0.605 - Satellite colonies

The analysis : 


```{r}
out1$mean$rho

```

```{r}

PR <- runif(1E8, 0.1, 3)

gvals = c(1.732, 0.605)

MCMCtrace(out1, params = c("rho"),
          Rhat = TRUE,
          priors = PR,
          gvals = gvals,
          ind = TRUE, pdf = FALSE,
          post_zm = F)


```

## Recruitment probability
D'après Péron: 

kappaLR = 0.619 - La Ronze

kappaSAT = 0.846 - Satellite colonies

The analysis : 


```{r}
out1$mean$kappa

```


```{r}


gvals = c(0.619, 0.846)

MCMCtrace(out1, params = c("kappa"),
          Rhat = TRUE,
          priors = PR_unif_01,
          gvals = gvals,
          ind = TRUE, pdf = FALSE,
          post_zm = F)


```

# Dispersion
## Natal dispersion "eta" from one colony to another - colony dependence 

```{r}
kable(out1$mean$eta_monitored, align = "c")
```

## Breeding dispersion "nu" from one colony to another - colony dependence
 
```{r}
kable(out1$mean$nu_monitored, align = "c")
```

### Traces of eta and nu
#### Traces of eta

```{r} 

MCMCtrace(out1, params = c("eta_monitored"),
          Rhat = TRUE,
          #priors = PR_unif_01,
          ind = TRUE, pdf = FALSE,
          post_zm = F)


```

Traces of nu

```{r} 

MCMCtrace(out1, params = c("nu_monitored"),
          Rhat = TRUE,
          #priors = PR_unif_01,
          ind = TRUE, pdf = FALSE,
          post_zm = F)
```

## Recapture probability
           
In the analysis:

```{r}
p1 = out1$mean$po[6,] %>% 
  as.data.frame() %>%
  mutate(., val = .) %>% 
  ggplot(., aes(x =val)) +
  geom_histogram() +
  labs(title = "La Ronze")


p2 = out1$mean$po[7:9,] %>% 
  as.vector() %>% 
  as.data.frame() %>%
  mutate(., val = .) %>% 
  ggplot(., aes(x =val)) +
  geom_histogram()+
  labs(title = "Les satellites")

p3 = p1 + p2

p3

```


```{r}
# Library
library(ggplot2)
library(hrbrthemes)

x = paste0("", seq(1,19))
y = paste0("Site", seq(1,4))
data <- expand.grid(X=x, Y=y)
data$Z <- out1$mean$po[6:9,] %>% 
  as.data.frame() %>% 
  t() %>% 
  as.vector()

ggplot(data, aes(X, Y, fill= Z)) + 
  geom_tile() +
  geom_text(aes(label = round(Z, 1))) +
  scale_fill_gradient(low="white", high="blue") +
  hrbrthemes::theme_ipsum	()

```


```{r}
load(file = "reading_effort.Rda")
```

Bilan issu de CH, nombre d adultes lus par site et par annee :

```{r}

rd_effort = reading_effort %>% 
  as.data.frame() %>% 
  slice(4:1)

kable(rd_effort, align = "c")
```




# Numbers of breeders and pre-breeders

```{r}


data_ = t(out1[["mean"]][["B"]])

df <- data.frame(
  Temps = rep(seq_len(nrow(data_)), time = ncol(data_)),
  Population = rep(c("pop1", "pop2", "pop3", "pop4", "pop5"), each = nrow(data_)),
  Valeur = as.vector(data_))

p3 = ggplot(df, aes(x = Temps, y = Valeur, color = Population)) +
  geom_line() +
  labs(title = "Breeders - d'après l'analyse",
       x = "Temps",
       y = "Nombre d'individus")

data_ = t(out1[["mean"]][["N"]])

df <- data.frame(
  Temps = rep(seq_len(nrow(data_)), time = ncol(data_)),
  Population = rep(c("pop1", "pop2", "pop3", "pop4", "pop5"), each = nrow(data_)),
  Valeur = as.vector(data_))

p4 = ggplot(df, aes(x = Temps, y = Valeur, color = Population)) +
  geom_line() +
  labs(title = "Prebreeders - d'après l'analyse",
       x = "Temps",
       y = "Nombre d'individus") +
  theme_minimal()



p3
p4
```
